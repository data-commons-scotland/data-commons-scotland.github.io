{"version":3,"sources":["dcs/prototype_6/ui_map.cljs"],"mappings":";AAIA,AAAA,AAAKA;AACL,AAAA,AAAKC;AACL,AAAA,AAAKC;AACL,AAAA,AAAKC;AACL,AAAA,AAAKC;AACL,AAAA,AAAKC;AACL,AAAA,AAAKC;AAEL,AAAKC,AAAiB,AAAA,AAACC;AACvB,AAAKC,AAAqB,AAAA,AAACD;AAG3B,AAAKE,AAAoB,AAAA,AAACC;AAE1B,AAAA,AAAA,AAAA,AAAA,AAAA,AAAKC;AAML,AAAA,AAAA,AAAA,AAAA,AAAA,AAAKC;AAKL,AAAA,AAAA,AAAA,AAAA,AAAA,AAAKC;AAKL,AAAA,AAAMC,AAAWC;AAAjB,AACM,AAAMC,AAAe,AAACC,AAAQ,AAAIF;AAC5BG,AAAO,AAAA,AAACC,AAAIH;AADlB,AAEK,AAEE,AAAI,AAAK,AAAA,AAAA,AAAAI,AAAA,AAAQC,AACR,AAAA,AAAAD,AAACE,AAAGD,AAAoBH;AAC/BN;;AACAD;;;AAEf,AAAA,AAAMY,AAAmBC;AAAzB,AACM,AAAUC,AAAE,AAAID;AACVR,AAAe,AAACC,AAAQ,AAAA,AAAIQ;AAC5BP,AAAO,AAAA,AAACC,AAAIH;AAFlB,AAGK,AACE,AAAcS;;AACd,AAAWA,AAAEZ;;AACb,AAAeY;;AAG5B,AAAA,AAAMC,AAAiBF;AAAvB,AACM,AAAMC,AAAE,AAAID;AAAZ,AAAAJ,AACMO,AAAenB;AADrB,AAEK,AACE,AAAeiB;;AACf,AAAaE,AAAcF;;AAExC,AAAA,AAAMG;AAAN,AACM,AAAAC,AAAA,AAAAT,AAAyBX;AAAzB,AAAA,AAAAoB;AAAA,AAAA,AAAAA,AAAWC;AAAX,AACU,AAAWA,AAAanB;;AADlC;;;AAGN,AAAA,AAAMoB,AAAiBP;AAAvB,AACM,AAAUC,AAAE,AAAID;AAAhB,AAAAJ,AACMY,AAAW1B;AACXU,AAAe,AAACC,AAAQ,AAAA,AAAIQ;AAC5BP,AAAO,AAAA,AAACC,AAAIH;AAHlB,AAIK,AACE,AAAM,AAAA,AAAAI,AAACa,AAAMZ,AAAoBH;AAAjC,AACM,AACE,AAACU;;AAED,AAAWH,AAAEb;;AACb,AAACsB,AAAOb,AAAoBH;;AAC5B,AAACgB,AAAOzB,AAAoBgB;;AANpC;;;AASb,AAAA,AAAMU,AAAqBpB,AAAQqB;AAAnC,AACM,AAAMpB,AAAe,AAACC,AAAQ,AAAIF;AAC5BG,AAAO,AAAA,AAACC,AAAIH;AADlB,AAEK,AACE,AAAcoB,AAAMlB;;AACpB,AAAA,AAAKkB,AAAqBb,AACAG,AACAK;;AAEvC,AAAA,AAAMM;AAAN,AACM,AAAML,AAAU,AAAMM,AAAKvC;AACrBwC,AAAc,AAAA,AAAYD,AAAKnC,AACYC,AACAC;AAHjD,AAIK,AACE,AAAC6B,AAAO5B,AAAiB0B;;AACzB,AAAUA,AAAU,AAAOhC,AAASC,AAAUC;;AAC9C,AAAQqC,AAAcP;;AAGnC,AAAA,AAAMQ,AAAYC,AAAKC;AAAvB,AACM,AAAMC,AAAQ,AAAA,AAAO,AAACC,AAAQH;AACxBd,AAAc,AAAA,AAAAP,AAAA,AAAUkB,AAAMO,AACc/B,AACAqB;AAHlD,AAAAf,AAIMY,AAAW1B;AAJjB,AAKK,AACE,AAAC4B,AAAO1B,AAAqBmB;;AAC7B,AAAQA,AAAcK;;AAEnC,AAAA,AAAMc;AAAN,AAAA,AAAA;;AAGA,AAAA,AAAMC;AAAN,AACM,AAAA,AAAA,AAAA,AAAA,AAACC,AAAsCF,AACAT,AACAG;;AAE7C,AAAA,AAAMS;AAAN,AAAA,AAAA,AAAA,AAAA,AAAA7B,AACO2B,AAAkBF","names":["dcs.prototype-6.ui-map/dom-id","dcs.prototype-6.ui-map/init-lat","dcs.prototype-6.ui-map/init-lng","dcs.prototype-6.ui-map/init-zoom","dcs.prototype-6.ui-map/basemap-url","dcs.prototype-6.ui-map/basemap-maxzoom","dcs.prototype-6.ui-map/basemap-attribution","dcs.prototype-6.ui-map/component-holder","reagent.core.atom","dcs.prototype-6.ui-map/geojson-layer-holder","dcs.prototype-6.ui-map/x-for-region-holder","cljs.core.atom","dcs.prototype-6.ui-map/style-neutral","dcs.prototype-6.ui-map/style-selected","dcs.prototype-6.ui-map/style-highlighted","dcs.prototype-6.ui-map/style","feature","properties-map","cljs.core.js__GT_clj","region","cljs.core.get","cljs.core/deref","dcs.prototype-6.state/region-holder","cljs.core._EQ_","dcs.prototype-6.ui-map/highlight-feature","e","x","dcs.prototype-6.ui-map/reset-highlight","geojson-layer","dcs.prototype-6.ui-map/style-neutral-the-previously-selected","temp__5735__auto__","x-for-region","dcs.prototype-6.ui-map/zoom-to-feature","component","cljs.core.not_EQ_","cljs.core/reset!","dcs.prototype-6.ui-map/on-each-feature","layer","dcs.prototype-6.ui-map/did-mount","js/L","basemap-layer","dcs.prototype-6.ui-map/did-update","this","prev-props","geojson","reagent.core/props","dcs.prototype-6.state/geojson-holder","dcs.prototype-6.ui-map/render","dcs.prototype-6.ui-map/component","reagent.core/create-class","dcs.prototype-6.ui-map/create"],"sourcesContent":["(ns dcs.prototype-6.ui-map\n  (:require [reagent.core :as r]\n            [dcs.prototype-6.state :as state]))\n\n(def dom-id \"map-ui\")\n(def init-lat 58.30)\n(def init-lng -3.70)\n(def init-zoom 6)\n(def basemap-url \"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\")\n(def basemap-maxzoom 18)\n(def basemap-attribution \"<a href='https://data-commons-scotland.github.io/dcs-wcs-prototype-3/pages-output/data/about/'>Data</a>\")\n\n(def component-holder (r/atom nil))\n(def geojson-layer-holder (r/atom nil))\n\n\n(def x-for-region-holder (atom nil)) ;; A hack. Replace the nedd for this with a function that find this in the geojson-layer using the name of the region.\n\n(def style-neutral #js{;; :fillColor getColor(feature.properties.density)\n                       :weight       1\n                       :opacity      0.7\n                       :color        \"gray\"\n                       \"fillOpacity\" 0.2})\n\n(def style-selected #js{:weight       1\n                        :color        \"#fdae6b\"\n                        \"dashArray\"   \"\"\n                        \"fillOpacity\" 0.2})\n\n(def style-highlighted #js{:weight       2\n                           :color        \"#666\"\n                           \"dashArray\"   \"\"\n                           \"fillOpacity\" 0.4})\n\n(defn style [^js feature]\n      (let [properties-map (js->clj (.. feature -properties))\n            region (get properties-map \"LAD13NM\")]\n           (do\n             #_(js/console.log (str \"styling \" region))\n             (if (and (some? @state/region-holder)\n                      (= @state/region-holder region))\n               style-selected\n               style-neutral))))\n\n(defn highlight-feature [e]\n      (let [^js x (.. e -target)\n            properties-map (js->clj (.. x -feature -properties))\n            region (get properties-map \"LAD13NM\")]\n           (do\n             (.openTooltip x)\n             (.setStyle x style-highlighted)\n             (.bringToFront x)\n             #_(js/console.log (str \"entered \" region)))))\n\n(defn reset-highlight [e]\n      (let [x (.. e -target)\n            geojson-layer @geojson-layer-holder]\n           (do\n             (.closeTooltip x)\n             (.resetStyle geojson-layer x))))\n\n(defn style-neutral-the-previously-selected []\n      (when-let [x-for-region @x-for-region-holder]\n                (.setStyle x-for-region style-neutral)))\n\n(defn zoom-to-feature [e]\n      (let [^js x (.. e -target)\n            component @component-holder\n            properties-map (js->clj (.. x -feature -properties))\n            region (get properties-map \"LAD13NM\")]\n           (do\n             (when (not= @state/region-holder region)\n                   (do\n                     (style-neutral-the-previously-selected) ;; Hack! There will be a more elegant way to achieve this\n                     ;(.fitBounds component (.getBounds x))\n                     (.setStyle x style-selected)\n                     (reset! state/region-holder region)\n                     (reset! x-for-region-holder x)))\n             #_(js/console.log (str \"selected \" region)))))\n\n(defn on-each-feature [^js feature layer]\n      (let [properties-map (js->clj (.. feature -properties))\n            region (get properties-map \"LAD13NM\")]\n           (do\n             (.bindTooltip layer region)\n             (.on layer #js{:mouseover highlight-feature\n                            :mouseout  reset-highlight\n                            :click     zoom-to-feature}))))\n\n(defn did-mount []\n      (let [component (.map js/L dom-id)\n            basemap-layer (.tileLayer js/L basemap-url\n                                      #js{\"maxZoom\"    basemap-maxzoom\n                                          :attribution basemap-attribution})]\n           (do\n             (reset! component-holder component)\n             (.setView component (array init-lat init-lng) init-zoom)\n             (.addTo basemap-layer component)\n             )))\n\n(defn did-update [this prev-props]\n      (let [geojson (:data (r/props this))\n            geojson-layer (.geoJson js/L @state/geojson-holder\n                                    #js{:style          style\n                                        \"onEachFeature\" on-each-feature})\n            component @component-holder]\n           (do\n             (reset! geojson-layer-holder geojson-layer)\n             (.addTo geojson-layer component))))\n\n(defn render []\n      [:div#map-ui.map-container])\n\n(defn component []\n      (r/create-class {:reagent-render       render\n                       :component-did-mount  did-mount\n                       :component-did-update did-update}))\n\n(defn create []\n      [component {:data @state/geojson-holder}])\n\n"]}
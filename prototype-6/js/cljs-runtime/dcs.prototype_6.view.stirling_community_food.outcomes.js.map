{"version":3,"sources":["dcs/prototype_6/view/stirling_community_food/outcomes.cljs"],"mappings":"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","names":["dcs.prototype-6.view.stirling-community-food.outcomes/chart-spec-per-outcome","data","title","dcs.prototype-6.view.stirling-community-food.outcomes/chart-spec-per-month","dcs.prototype-6.view.stirling-community-food.outcomes/chart-spec-per-month-logarithmic","cljs.core/assoc-in","dcs.prototype-6.view.stirling-community-food.outcomes/charts","derivation-tonnes","chart-data","p1__33507#","cljs.core.filter","cljs.core._EQ_","total-received","p1__33508#","cljs.core/group-by","cljs.core.map","p__33509","vec__33510","cljs.core.nth","yyyy-MM-dd","coll","cljs.core.apply","cljs.core/+","chart-data-plus","cljs.core.concat","oz.core/vega-lite","dcs.prototype-6.util/vega-embed-opts","cljs.core/deref","dcs.prototype-6.view.stirling-community-food.outcomes/root","dcs.prototype-6.state/stirling-community-food-tonnes-derivation-tonnes-cursor"],"sourcesContent":["(ns dcs.prototype-6.view.stirling-community-food.outcomes\n  (:require\n    [oz.core :as oz]\n    [dcs.prototype-6.util :as util]\n    [dcs.prototype-6.state :as state]))\n\n\n(defn chart-spec-per-outcome\n      [data title]\n      {:schema     \"https://vega.github.io/schema/vega/v5.json\"\n       :width      370\n       :height     200\n       :background \"#f2dfce\"\n       :title title\n       :data       {:values data}\n       :transform  [{:calculate \"datum['counter-party']\" :as \"outcome\"}\n                    {:aggregate [{:op \"sum\" :field \"tonnes\" :as \"tonnes\"}]\n                     :groupby [\"outcome\"]}]\n       :mark       {:type \"bar\"\n                    :cornerRadiusTopLeft  3\n                    :cornerRadiusTopRight 3}\n       :encoding   {:x       {:field \"outcome\" :type \"nominal\"\n                              :axis {:labelAngle 45\n                                     :labelBound 45}\n                              :sort {:field \"tonnes\" :order \"descending\"}}\n                    :y       {:field \"tonnes\" :type \"quantitative\"}\n                    :color {:field \"outcome\" :type \"nominal\"\n                            :scale {:domain [\"Used as food\"\n                                             \"Donated to animal sanctuary\"\n                                             \"Used by individuals for compost\"\n                                             \"Council compost, Energen biogas, etc.\"]\n                                    :range  [\"#00AC8F\"\n                                             \"#006AC7\"\n                                             \"#B49531\"\n                                             \"#E27E44\"]}\n                            :legend {:symbolType \"circle\"\n                                     :orient \"bottom\" :columns 2}}\n                    :tooltip [{:field \"outcome\" :type \"nominal\"}\n                              {:field \"tonnes\" :type \"quantitative\"}]}})\n\n(defn chart-spec-per-month\n      [data title]\n      {:schema     \"https://vega.github.io/schema/vega/v5.json\"\n       :width      370\n       :height     200\n       :background \"#f2dfce\"\n       :title title\n       :data       {:values data}\n       :transform  [{:calculate \"datum['counter-party']\" :as \"outcome\"}\n                    {:timeUnit \"yearmonth\" :field \"yyyy-MM-dd\" :as \"month\"}\n                    {:aggregate [{:op \"sum\" :field \"tonnes\" :as \"tonnes\"}]\n                     :groupby [\"month\" \"outcome\"]}]\n       :mark       {:type \"line\"\n                    :point {:filled false :fill \"#f2dfce\"}}\n       :encoding   {:x       {:field \"month\" :type \"temporal\"\n                              :axis {:format \"%b %y\"\n                                     :labelAngle 60\n                                     :labelBound 45}}\n                    :y       {:field \"tonnes\" :type \"quantitative\"}\n                    :strokeDash {:condition {:test  \"datum.outcome == 'Total received'\"\n                                             :value [5 5]}\n                                 :value     [0]}\n                    :color   {:field \"outcome\" :type \"nominal\"\n                              :scale {:domain [\"Used as food\"\n                                               \"Donated to animal sanctuary\"\n                                               \"Used by individuals for compost\"\n                                               \"Council compost, Energen biogas, etc.\"\n                                               \"Total received\"]\n                                      :range  [\"#00AC8F\"\n                                               \"#006AC7\"\n                                               \"#B49531\"\n                                               \"#E27E44\"\n                                               \"grey\" #_\"#B1AB99\"]}\n                              :legend {:orient \"bottom\" :columns 2}}\n                    :tooltip [{:field \"outcome\" :type \"nominal\"}\n                              {:field \"month\" :type \"temporal\" :format \"%b %Y\"}\n                              {:field \"tonnes\" :type \"quantitative\"}]}})\n\n(defn chart-spec-per-month-logarithmic\n      [data title]\n      (-> (chart-spec-per-month data title)\n        (assoc-in [:encoding :y :scale] {:type \"log\"})\n          (assoc-in [:encoding :color :legend] nil)))\n\n\n(defn charts [derivation-tonnes]\n      (let [chart-data (->> derivation-tonnes\n                            (filter #(= \"out\" (:io-direction %))))\n            total-received (->> derivation-tonnes\n                                     (filter #(= \"in\" (:io-direction %)))\n                                     (group-by :yyyy-MM-dd)\n                                     (map (fn [[yyyy-MM-dd coll]] {:yyyy-MM-dd    yyyy-MM-dd\n                                                                   :counter-party \"Total received\"\n                                                                   :tonnes        (->> coll\n                                                                                       (map :tonnes)\n                                                                                       (apply +))})))\n            chart-data-plus (concat\n                                  chart-data\n                                  ;; for comparison, include the total received\n                                  total-received)]\n\n           [:div.tile.is-ancestor\n\n            [:div.tile.is-6\n             [:div.tile.is-vertical.is-parent\n\n              [:div.tile.is-child\n               [oz/vega-lite (chart-spec-per-outcome chart-data \"Graph 5: Outgoing amount per destination\")\n                util/vega-embed-opts]]\n              [:div.tile.is-child\n               [:div.tile.is-child.content\n                [:p \"Graph 5 shows that Stirling Community Food has\n                provided (for free) to the community during the year:\"]\n                 [:ul\n                  [:li \"71.5 tonnes of food to people\"]\n                  [:li \"3.7 tonnes of waste food to Stirling council (for compost) and to Energen (for biogas and fertiliser)\"]\n                  [:li \"2 tonnes of food to an animal sanctuary\"]\n                  [:li \"1.4 tonnes to individuals for compost\"]\n                  ]\n                [:p \"Graphs 6 & 7 provide month-by-month breakdowns, \n               with Graph 7 using a non-linear scale to make differences more obvious.\n               Changes in amounts outgoing coincide with the changes in amounts received \"\n               [:span.has-text-grey \"(depicted by the dashed grey line the next graph)\"] \".\"]]]]]\n\n            [:div.tile\n             [:div.tile.is-vertical.is-parent\n\n              [:div.tile.is-child\n               [oz/vega-lite (chart-spec-per-month chart-data-plus \"Graph 6: Outgoing amounts per month\")\n                util/vega-embed-opts]]\n              [:div.tile.is-child\n               [oz/vega-lite (chart-spec-per-month-logarithmic chart-data \"Graph 7: Outgoing amounts per month (non-linear)\")\n                util/vega-embed-opts]]]]]))\n\n(defn root []\n      [charts\n       @state/stirling-community-food-tonnes-derivation-tonnes-cursor])"]}
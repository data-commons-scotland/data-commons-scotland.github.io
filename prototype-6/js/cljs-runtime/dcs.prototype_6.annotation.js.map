{"version":3,"sources":["dcs/prototype_6/annotation.cljs"],"mappings":"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","names":["p1__51305#","p1__51306#","p1__51307#","p1__51308#","p1__51309#","p1__51310#","p1__51311#","p1__51312#","p1__51313#","p1__51314#","p1__51315#","p1__51316#","p1__51317#","p1__51318#","p1__51319#","dcs.prototype-6.annotation/annotations","cljs.core._EQ_","dcs.prototype-6.annotation/layer-annotations","dcs.prototype-6.annotation/find-indexes","coll","pred","p1__51321#","p2__51320#","cljs.core.keep_indexed","cljs.core.remove","cljs.core/nil?","dcs.prototype-6.annotation/annotation-symbol","p__51322","map__51323","cljs.core/--destructure-map","cljs.core.get","dcs.prototype-6.annotation/add-annotation","data-vector","id","text","indexes","indexes-todo","data-vector-updated","cljs.core/empty?","cljs.core/rest","ix","cljs.core/first","cljs.core/assoc-in","var_args","G__51326","dcs.prototype-6.annotation/add-annotations","js/Error","annotations-todo","data-vector-with-annotations","data-coll","record-type","dcs.prototype_6.annotation.add_annotations","cljs.core/vec","p1__51324#","cljs.core.map","cljs.core.assoc","dcs.prototype-6.annotation/vega-like-tooltip","anchor"],"sourcesContent":["(ns dcs.prototype-6.annotation)\n\n\n\n;; ------------------------------------------------------------------------\n\n(def annotations\n  \n  [;; household-waste-analysis\n\n   {:id   \"3\"\n    :text \"We can see that rural \u00a3/\u00a3\u00a3 households dispose of a lot of fine-grained material, i.e. Fines (<10mm). \n                        Also, they dispose of a sizable portion of it inappropriately in recycling bins.\"\n    :pred #(and (= :household-waste-analysis-derivation (:record-type %))\n                (= \"Fines (<10mm)\" (:material-L2 %))\n                (= \"rural \u00a3/\u00a3\u00a3\" (:stratum %))\n                (= \"recycling bin\" (:stream %)))}\n   {:id   \"4\"\n    :text \"Urban \u00a3\u00a3\u00a3 households dispose of a lot of Green garden waste inappropriately in comparison to their rural \u00a3\u00a3\u00a3 peers. \n                        Is that because urban \u00a3\u00a3\u00a3 households have fewer convenient spaces in which to heap their garden waste! \n                        Perhaps, but it is foolish to make such inferences from data (such as this) which covers a relatively small number of observations.\"\n    :pred #(and (= :household-waste-analysis-derivation (:record-type %))\n                (= \"Green garden waste\" (:material-L2 %))\n                (= \"urban \u00a3\u00a3\u00a3\" (:stratum %))\n                (= \"grey bin\" (:stream %)))}\n\n   ;; regional-dashboard\n\n   ;; Scot gov target\n\n   {:id \"1\"\n    :text \"By 2025, the Scottish Government aims to reduce total waste arising in Scotland by 15% against 2011 levels.\"\n    :pred #(and (= :household-waste-derivation-generation (:record-type %))\n                (= \"Scot gov target\" (:region %))\n                (= \"2019\" (:year %)))}\n\n   {:id \"2\"\n    :text \"By 2025, the Scottish Government aims to recycle 70% of remaining waste.\"\n    :pred #(and (= :household-waste-derivation-percent-recycled (:record-type %))\n                (= \"Scot gov target\" (:region %))\n                (= \"2019\" (:year %)))}\n   \n   ;; Angus\n\n    {:id \"15\"\n     :text \"In 2018, Angus processed more waste by ('Other Diversion') incenerating, converting to bio gas, etc. than by landfilling.\"\n     :pred #(and (= :household-waste-derivation-management (:record-type %))\n                 (= \"Angus\" (:region %))\n                 (= \"2018\" (:year %))\n                 (= \"Other Diversion\" (:management %)))}\n   \n   ;; Inverclyde\n\n   {:id \"9\"\n    :text \"Inverclyde's household waste per person has been consistently better than the Scottish average.\n           In 2019 it reported the best household waste per person of any of the reporting areas, at just under 0.36 tonnes per person.\"\n    :pred #(or (and (= :household-waste-derivation-generation-positions (:record-type %))\n                    (= \"Inverclyde\" (:region %)))\n               (and (= :household-waste-derivation-generation (:record-type %))\n                    (= \"Inverclyde\" (:region %))\n                    (= \"2019\" (:year %))))}\n   \n   {:id \"10\"\n    :text \"The fraction of household waste sent for recycling is better than the Scottish average, with less than 50% going to landfill every year since 2012. \n           It would be interesting to know what is behind these positive figures;\n           is it because of Inverclyde's small size, good transport links and therefore accessiblity of recycling facilities compared to more dispersed and geographically remote regions. \n           Interestingly, the significant increase in recycling rates seen between 2011 and 2013 suggests that something changed in the region in this period. \n           Were there changes to waste collections, processing, or perhaps people's awareness of the importance of waste? \n           Or was there some other factor?\"\n    :pred #(and (= :household-waste-derivation-percent-recycled (:record-type %))\n                (= \"Inverclyde\" (:region %))\n                (= \"2019\" (:year %)))}\n   \n      {:id \"11\"\n       :text \"These business waste figures raises some questions. \n              For example, between 2014 and 2017, Vegetal wastes appeared to almost vanish from Inverclyde's business, only to return in 2018. \n              Was this real, and if so what caused it - or was it because of a temporary change in reporting?\"\n       :pred #(and (= :business-waste-by-region-derivation-composition (:record-type %))\n                   (= \"Inverclyde\" (:region %))\n                   (= \"2013\" (:year %))\n                   (= \"Vegetal wastes\" (:material %)))}\n   \n       {:id \"12\"\n        :text \"In 2018 the category Common sludges (which refers to sludges produced from waste water treatment and from food preparation and processing) has reduced significantly. \n               Is this because of improved processes or because of changes to what businesses are operating in the region - for example, has a food processing business closed down or moved away?\"\n        :pred #(and (= :business-waste-by-region-derivation-composition (:record-type %))\n                    (= \"Inverclyde\" (:region %))\n                    (= \"2018\" (:year %))\n                    (= \"Common sludges\" (:material %)))}\n      \n      {:id \"14\"\n       :text \"In 2019 it reported the best household CO2e per person of any of the reporting areas, at just under 0.75 tonnes per person.\"\n       :pred #(or (and (= :household-co2e-derivation-generation-positions (:record-type %))\n                       (= \"Inverclyde\" (:region %)))\n                  (and (= :household-co2e-derivation-generation (:record-type %))\n                       (= \"Inverclyde\" (:region %))\n                       (= \"2019\" (:year %))))}\n\n   ;; Fife\n\n   {:id \"5\"\n    :text \"There is a big change in the amount of Combustion wastes between 2015 and 2017, \n           with this category going from the biggest contributor to business waste to one of the smallest. \n           Is this the result of the closure of Longannet power station in 2016?\"\n    :pred #(and (= :business-waste-by-region-derivation-composition (:record-type %))\n                (= \"Fife\" (:region %))\n                (= \"2016\" (:year %))\n                (= \"Combustion wastes\" (:material %)))}\n\n   ;; Stirling\n\n   {:id \"6\"\n    :text \"There are some fluctuations in Stirling's business waste, including an interesting change in the Soils category which almost entirely disappears from 2015 onwards.\"\n    :pred #(and (= :business-waste-by-region-derivation-composition (:record-type %))\n                (= \"Stirling\" (:region %))\n                (= \"2015\" (:year %))\n                (= \"Soils\" (:material %)))}\n   \n      {:id \"13\"\n       :text \"Stirling has been doing consistently better than average in terms of the fraction of household waste going to recycling \n              - but like most other regions, even more is going to need to be achieved if the Government's target is going to be met by 2025.\"\n       :pred #(and (= :household-waste-derivation-percent-recycled (:record-type %))\n                   (= \"Stirling\" (:region %))\n                   (= \"2019\" (:year %)))}\n\n   ;; Outer Hebrides\n\n   {:id \"7\"\n    :text \"Like other island and rural regions, the Outer Hebrides sends a lower-than-average fraction of its household waste for recycling. \n           However it is important to realise that collecting and processing recycling is not so easy for a distributed community without major transport infrastructure. \n           Also, shipping materials long distances to recycling facilitaites bears its own environmental costs in carbon emissions and pollution associated with transport.\"\n    :pred #(and (= :household-waste-derivation-percent-recycled (:record-type %))\n                (= \"Outer Hebrides\" (:region %))\n                (= \"2019\" (:year %)))}\n   \n   {:id \"8\"\n    :text \"A large drop in the amount of business waste reported between 2011 and 2012, followed by a sustained increase up to 2019, when levels had almost returned to those of 2011. \n           These changes are almost entirely down to changes in the category Other mineral wastes. \n           Were these changes real, or are they a result of a change in the way a certain type of waste was reported?\n           A related curiousity is the large amount of Soils that came into the Bennadrove landfill site on the Isle of Lewis in 2019.\"\n    :pred #(and (= :business-waste-by-region-derivation-composition (:record-type %))\n                (= \"Outer Hebrides\" (:region %))\n                (= \"2012\" (:year %))\n                (= \"Other mineral wastes\" (:material %)))}\n\n\n   ])\n\n;; ------------------------------------------------------------------------\n\n\n\n\n(def layer-annotations {:transform [{:filter \"datum.annotation != null\"}]\n                        :mark {:type \"text\"\n                               :align \"left\"\n                               :dx 10\n                               ;; :dy -5\n                               ;; _:baseline \"bottom\"\n                               :fontWeight \"bold\"\n                               :fontSize 14\n                               :fill \"blue\"\n                               :fillOpacity 1\n                               :stroke \"white\"\n                               :strokeOpacity 0\n                               :strokeWidth 5}\n                        :encoding {:text {:field \"annotation\"}\n                                   :tooltip [{:field \"annotation\"\n                                              :type  \"nominal\"\n                                              :title \"id\"}\n                                             {:field \"annotation-text\"\n                                              :type  \"nominal\"\n                                              :title \"info\"}]\n                                   ;;:href {:field \"annotation-url\" :type \"nominal\"}\n                                   }})\n\n\n(defn find-indexes [coll pred]\n  (->> coll\n       (keep-indexed #(if (pred %2) %1 nil))\n       (remove nil?)))\n\n;; \ud83d\udc4b  \u270b  \u2757  \u2049\ufe0f  \ud83d\udfe2  \u2139\ufe0f  \ud83d\udd0d  \ud83d\udccd \ud83d\udcc8 \ud83d\udcc9 \ud83d\udcca  \u2705  \u274c  \ud83d\udc4e  \ud83d\udc4d  \ud83e\udd14 \ud83e\udd28 \ud83d\udea9 \ud83d\udcac  \n(def annotation-symbol \"\ud83d\udc4b\")\n\n(defn add-annotation [data-vector {:keys [id text pred]}]\n  (let [indexes (find-indexes data-vector pred)]\n    (loop [indexes-todo indexes\n           data-vector-updated data-vector]\n      (if (empty? indexes-todo)\n        data-vector-updated\n        (recur (rest indexes-todo)\n               (let [ix (first indexes-todo)]\n                 (-> data-vector-updated\n                   \n                   (assoc-in [ix :annotation] (str annotation-symbol id)) \n                   (assoc-in [ix :annotation-text] text)\n                   (assoc-in [ix :annotation-url] \"#\") ;;TODO maybe replace with View API click event listener\n                   )))))))\n\n\n(defn add-annotations\n  ([data-vector]\n   (loop [annotations-todo annotations\n          data-vector-with-annotations data-vector]\n     (if (empty? annotations-todo)\n       data-vector-with-annotations\n       (recur (rest annotations-todo)\n              (add-annotation data-vector-with-annotations (first annotations-todo))))))\n  ([data-coll record-type]\n   (add-annotations (vec (map #(assoc % :record-type record-type) data-coll)))))\n\n\n(defn vega-like-tooltip [anchor text]\n  [:span.dropdown.is-hoverable\n   [:span.dropdown-trigger\n    [:span.is-ghost [:b {:style {:color \"blue\" :font-size \"small\"}} anchor]]]\n   [:span.dropdown-menu\n    [:div#vg-tooltip-like\n     [:table\n      [:tbody\n       [:tr\n        [:td.key \"id:\"]\n        [:td.value anchor]]\n       [:tr\n        [:td.key \"info:\"]\n        [:td.value text]]]]]]])"]}